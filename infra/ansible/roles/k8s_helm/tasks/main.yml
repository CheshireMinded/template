---
- name: Install kubectl prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - apt-transport-https
    state: present
    update_cache: yes
  tags: [k8s, helm]

- name: Download kubectl
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ kubectl_version | default('stable') }}/bin/linux/amd64/kubectl"
    dest: /tmp/kubectl
    mode: '0755'
  tags: [k8s, helm]

- name: Install kubectl
  ansible.builtin.copy:
    src: /tmp/kubectl
    dest: /usr/local/bin/kubectl
    mode: '0755'
    remote_src: yes
  tags: [k8s, helm]

- name: Install Helm
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get-helm-3.sh
    mode: '0755'
  tags: [k8s, helm]

- name: Run Helm installer
  ansible.builtin.command: /tmp/get-helm-3.sh
  args:
    creates: /usr/local/bin/helm
  tags: [k8s, helm]

- name: Select values file based on environment
  ansible.builtin.set_fact:
    helm_values_file: "infra/helm/web-platform/values-{{ environment }}.yaml"
  tags: [k8s, helm]

- name: Fallback to default values.yaml if env-specific file does not exist
  ansible.builtin.stat:
    path: "{{ app_root }}/{{ helm_values_file }}"
  register: env_values_stat
  tags: [k8s, helm]

- name: Use default values.yaml if env-specific file missing
  ansible.builtin.set_fact:
    helm_values_file: "infra/helm/web-platform/values.yaml"
  when: not env_values_stat.stat.exists
  tags: [k8s, helm]

- name: Deploy via Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade --install web-platform infra/helm/web-platform
      -f {{ helm_values_file }}
    chdir: "{{ app_root }}"
  tags: [deploy, k8s, helm]

