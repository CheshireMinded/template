---
- name: Update apt cache (if enabled)
  ansible.builtin.apt:
    update_cache: yes
  when: update_system_packages | default(true)
  tags: [common]

- name: Install base packages
  ansible.builtin.apt:
    name:
      - git
      - curl
      - ca-certificates
    state: present
  tags: [common]

- name: Ensure Python 3 and pip are installed (required for Ansible modules)
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
    state: present
  tags: [common, python]

- name: Install python3-venv (only if venv will be created)
  ansible.builtin.apt:
    name:
      - python3-venv
    state: present
  when: setup_python_venv | default(false)
  tags: [common, python, venv]

- name: Ensure application root exists
  ansible.builtin.file:
    path: "{{ app_root }}"
    state: directory
    mode: "0755"
  tags: [common]

- name: Clone or update template repo
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ app_root }}"
    version: main
  tags: [common, git]

- name: Create Python virtual environment (if enabled)
  ansible.builtin.command:
    cmd: python3 -m venv {{ python_venv_path }}
    creates: "{{ python_venv_path }}/bin/activate"
  when: setup_python_venv | default(false)
  tags: [common, python, venv]

- name: Install Python requirements in venv (if enabled)
  ansible.builtin.pip:
    requirements: "{{ app_root }}/requirements/python-requirements.txt"
    virtualenv: "{{ python_venv_path }}"
    virtualenv_python: python3
  when: setup_python_venv | default(false) and install_python_requirements | default(false)
  tags: [common, python, venv, requirements]

